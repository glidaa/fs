{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"Lambda Function resource stack creation using Amplify CLI",
    "Parameters":{
        "CloudWatchRule":{
            "Type":"String",
            "Default":"NONE",
            "Description":" Schedule Expression"
        },
        "deploymentBucketName":{
            "Type":"String"
        },
        "env":{
            "Type":"String"
        },
        "s3Key":{
            "Type":"String"
        },
        "apiGraphQLAPIIdOutput":{
            "Type":"String"
        }
    },
    "Conditions":{
        "ShouldNotCreateEnvResources":{
            "Fn::Equals":[
                {
                    "Ref":"env"
                },
                "NONE"
            ]
        }
    },
    "Resources":{
        "LambdaFunction":{
            "Type":"AWS::Lambda::Function",
            "Metadata":{
                "aws:asset:path":"./src",
                "aws:asset:property":"Code"
            },
            "Properties":{
                "Code":{
                    "S3Bucket":{
                        "Ref":"deploymentBucketName"
                    },
                    "S3Key":{
                        "Ref":"s3Key"
                    }
                },
                "Handler":"index.handler",
                "FunctionName":{
                    "Fn::If":[
                        "ShouldNotCreateEnvResources",
                        "graphqlresolver",
                        {
                            "Fn::Join":[
                                "",
                                [
                                    "graphqlresolver",
                                    "-",
                                    {
                                        "Ref":"env"
                                    }
                                ]
                            ]
                        }
                    ]
                },
                "Environment":{
                    "Variables":{
                        "ENV":{
                            "Ref":"env"
                        },
                        "REGION":{
                            "Ref":"AWS::Region"
                        },
                        "PROJECTTABLE":{
                            "Fn::ImportValue":{
                                "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:ProjectTable:Name"
                            }
                        },
                        "NOTETABLE":{
                            "Fn::ImportValue":{
                                "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:NoteTable:Name"
                            }
                        },
                        "COMMENTTABLE":{
                            "Fn::ImportValue":{
                                "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:CommentTable:Name"
                            }
                        },
                        "AWS_NODEJS_CONNECTION_REUSE_ENABLED":1
                    }
                },
                "Role":{
                    "Fn::GetAtt":[
                        "LambdaExecutionRole",
                        "Arn"
                    ]
                },
                "Runtime":"nodejs14.x",
                "Layers":[
                    
                ],
                "Timeout":"25"
            }
        },
        "LambdaExecutionRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "RoleName":{
                    "Fn::If":[
                        "ShouldNotCreateEnvResources",
                        "fstesttttLambdaRole6dea11e1",
                        {
                            "Fn::Join":[
                                "",
                                [
                                    "fstesttttLambdaRole6dea11e1",
                                    "-",
                                    {
                                        "Ref":"env"
                                    }
                                ]
                            ]
                        }
                    ]
                },
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Principal":{
                                "Service":[
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action":[
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                }
            }
        },
        "AccessDynamoDBApiResourcesPolicy":{
            "DependsOn":[
                "LambdaExecutionRole"
            ],
            "Type":"AWS::IAM::Policy",
            "Properties":{
                "PolicyName":"amplify-lambda-execution-policy",
                "Roles":[
                    {
                        "Ref":"LambdaExecutionRole"
                    }
                ],
                "PolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":[
                                "dynamodb:BatchWriteItem",
                                "dynamodb:List*",
                                "dynamodb:Query",
                                "dynamodb:GetItem",
                                "dynamodb:Update*",
                                "dynamodb:PutItem",
                                "dynamodb:Delete*"
                            ],
                            "Resource":[
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}/index/*",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:ProjectTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                },
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:ProjectTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                },
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:NoteTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                },
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}/index/*",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:NoteTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                },
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:CommentTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                },
                                {
                                    "Fn::Sub":[
                                        "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${tablename}/index/*",
                                        {
                                            "tablename":{
                                                "Fn::ImportValue":{
                                                    "Fn::Sub":"${apiGraphQLAPIIdOutput}:GetAtt:CommentTable:Name"
                                                }
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "lambdaexecutionpolicy":{
            "DependsOn":[
                "LambdaExecutionRole"
            ],
            "Type":"AWS::IAM::Policy",
            "Properties":{
                "PolicyName":"lambda-execution-policy",
                "Roles":[
                    {
                        "Ref":"LambdaExecutionRole"
                    }
                ],
                "PolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[
                        {
                            "Effect":"Allow",
                            "Action":[
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource":{
                                "Fn::Sub":[
                                    "arn:aws:logs:${region}:${account}:log-group:/aws/lambda/${lambda}:log-stream:*",
                                    {
                                        "region":{
                                            "Ref":"AWS::Region"
                                        },
                                        "account":{
                                            "Ref":"AWS::AccountId"
                                        },
                                        "lambda":{
                                            "Ref":"LambdaFunction"
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        }
    },
    "Outputs":{
        "Name":{
            "Value":{
                "Ref":"LambdaFunction"
            }
        },
        "Arn":{
            "Value":{
                "Fn::GetAtt":[
                    "LambdaFunction",
                    "Arn"
                ]
            }
        },
        "Region":{
            "Value":{
                "Ref":"AWS::Region"
            }
        },
        "LambdaExecutionRole":{
            "Value":{
                "Ref":"LambdaExecutionRole"
            }
        }
    }
}
